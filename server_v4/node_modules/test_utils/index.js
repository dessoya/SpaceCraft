'use strict'

var tcc				= require('tcc')
  , fs				= require('fs')
  , coroutine		= require('coroutine')
  , util			= require('util')

var iterator = 1

var create_cc = coroutine(function*(models, g) {
	
	var config = JSON.parse('' + (yield fs.readFile('/home/sc/server_v4/test.config.json', g.resume)))
	var cc = tcc.create(config.cassandra)
	var keyspace = "testks_" + (iterator ++)

	cc.keyspace_ = keyspace
	yield cc.query("CREATE KEYSPACE " + keyspace + " WITH replication = " + JSON.stringify(config.keyspaceConfig).replace(/"/g, "'"), g.resume)
	
	while (true) {
		var result = yield cc.query("use " + keyspace, g.resumeWithError)
		if(result[0]) {
			yield setTimeout(g.resume, 100)
		}
		else {
			break
		}
	}

	for(var i = 0, c = models.length; i < c; i++) {
		var model = models[i]
		yield model.install(cc, g.resume)
	}

	cc.remove = coroutine.method(function*(cc, g) {
		yield cc.query("drop keyspace " + cc.keyspace_, g.resume)
	})

	return cc
})



module.exports = {
	create_cc: create_cc
}